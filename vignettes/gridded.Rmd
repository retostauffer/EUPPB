---
title: "Getting gridded data"
---


![Rough scheme on the download/processing process.](images/download_grib.svg)

The data sets are stored as GRIB version 1 files on the servers alongside
with a GRIB index file which contains the inventory. The inventory contains
information of all fields inside the GRIB file and allows to partially
download the fields.

When downloading data, the package always first accesses the index file
via `eupp_get_inventory()` before starting to download the data.
`eupp_download_gridded()` will download (parts) of the GRIB file and
either store it as GRIB, or converts it to NetCDF (requires NetCDF support and ecCodes
to be installed; see installation notes).

`eupp_get_gridded()` interfaces `eupp_download_gridded()` but deletes the file
after use and returns an _R_ object. This can be handy for small tasks or checks,
or if you want to store the data as _R_ objects yourself. Also requires NetCDF support.


## Specify data to be downloaded

Before starting downloading data a configuration object must be created using
`eupp_config()` which contains the specification of the data to be retrieved.

```{r, include = FALSE}
suppressPackageStartupMessages(library("eupp"))
suppressPackageStartupMessages(library("sf"))
suppressPackageStartupMessages(library("stars"))
```

```{r, include = FALSE}
dir.create("_cache", showWarnings = FALSE) # Not mandatory
```

```{r}
# Loading the package
library("eupp")

# Create custom configuration
conf <- eupp_config(product   = "forecast",
                    level     = "surf",
                    type      = "ens",
                    date      = "2017-07-01",
                    parameter = c("cp", "2t"),
                    steps     = c(24L, 240L), # +1 and +10 days ahead
                    cache     = "_cache") # cache is not required
```

## Where is the data?

If you are interested where the data is stored, you can make use of the
function `eupp_get_source_url()`. Typically not required to be used by an end-user.

```{r}
urls <- eupp_get_source_urls(conf)                           # GRIB file
urls <- eupp_get_source_urls(conf, fileext = "index")        # GRIB index/inventory
```

## Getting GRIB inventory

Given the same object `conf` we can retrieve the GRIB inventory which matches
our requirements.

```{r}
inv <- eupp_get_inventory(conf)
head(inv)
```

As we have set `cache` when calling `eupp_config()` the GRIB index file is stored
locally, if the same index file is required once again the loading times should
be much faster. Not required but may save some time in certain situations.


## Getting data: GRIB format

From `eupp_get_inventory()` we know that there are `r nrow(inv)` fields matching
our configuration. `eupp_download_gridded()` allows us to retrieve the data in
either GRIB or NetCDF (next section). 

Will internally access the GRIB index and download the fields matching our
configuration. The data is stored in `output_file` (GRIB version 1 format).

```{r}
eupp_download_gridded(conf, output_file = "_test.grb", output_format = "grib", overwrite = TRUE)
```

## Getting data: NetCDF

When the `output_file` can be identified as a NetCDF file or `output_format` is explicitly
set to `"nc"` the resulting file will be a NetCDF file (classic 64 bit NetCDF) file.
This requires [ecCodes](https://confluence.ecmwf.int/display/ECC/ecCodes+Home) to be installed
as the R package will call `grib_to_netcdf` for format conversion.

```{r}
eupp_download_gridded(conf, output_file = "_test.nc", output_format = "nc", overwrite = TRUE)
```

Which can be processed using e.g., `[ncdf4](https://cran.r-project.org/package=ncdf4)`,
`[stars](https://cran.r-project.org/package=stars)` or the package of your choice.

##### Reading data using `ncdf4`

```{r}
library("ncdf4")
nc <- nc_open("_test.nc")
nc
```

##### Reading data using `stars`

```{r demoplot_stars, fig = TRUE, fig.width = 10, fig.height = 5, out.width = "100%"}
library("stars")
x <- read_stars("_test.nc")
print(x)
dim(x)
names(x)

# Plotting 2m dry air temperature
plot(x["t2m"],
     main   = "t2m",
     col    = hcl.colors(21, "Blue-Red 2", rev = TRUE),
     breaks = seq(min(x$t2m, na.rm = TRUE), max(x$t2m, na.rm = TRUE), length = 22))

# Plotting convective precipitation (mm)
plot(x["cp"] * 1e3,
     main   = "cp",
     col    = hcl.colors(10, "Purple-Yellow", rev = TRUE),
     breaks = 1e3 * seq(0, as.numeric(max(x$cp, na.rm = TRUE)), length = 11))
```

An alternative way to visualize the data using `[ggplot2](https://cran.r-project.org/package=ggplot2)`,
`[colorspace](https://cran.r-project.org/package=colorspace)` and 
`[sf](https://cran.r-project.org/package=sf)` as well as 
`[rnaturalearth](https://cran.r-project.org/package=rnaturalearth)` for outlines:
```


```{r demoplot_ggplot, fig = TRUE, fig.width = 10, fig.height = 7, out.width = "60%", fig.align = "center"}
library("sf")
library("ggplot2")
library("colorspace")
library("rnaturalearth")

ne <- ne_countries(continent = "europe", returnclass = "sf")
st_crs(x) <- st_crs(ne)

ggplot() + geom_stars(data = x["cp"] * 1e3, sf = TRUE) +
           facet_wrap("time") +
           scale_fill_continuous_sequential("Purple-Yellow") +
           geom_sf(data = ne, fill = "transparent") +
           coord_sf(xlim = c(-6, 17), ylim = c(36, 67), expand = FALSE)
```

```{r, eval = FALSE, include = FALSE}
# Wanted to first crop 'ne' to the bbox of 'x'
# beore using a different projection (as xlim/ylim change).
# not working; issues with ne?
crs = st_crs("ESRI:102014")
```

TODOD: WHAT? :)


```{r gridded_cleaning_up, include = FALSE}
if (dir.exists("_cache")) unlink("_cache")
if (file.exists("_test.nc")) unlink("_test.nc")
if (file.exists("_test.grb")) unlink("_test.grb")
```




