---
title: "Getting started with gridded data"
---

```{r, include = FALSE}
suppressPackageStartupMessages(library("eupp"))
suppressPackageStartupMessages(library("sf"))
suppressPackageStartupMessages(library("stars"))
```

This _eupp_ package provides access to a variety of gridded data sets provided
within the scope of the European Post-Processing benchmark project.

The gridded data sets consists of (re)analysis data used as the gridded ground-trough
in some scenarios, deterministic and ensemble forecasts for the training and test
period defined within the project as well as hindcasts (or reforecasts) to be worked
with. While the different data sets differ in form and extent, the _eupp_ package
provides a uniform interface to download and--to some extent--process the data.

## Purpose of this article

This article (_Getting started with gridde data_) shows the main use the
`eupp_*_gridded()` functionality with some minimal examples on how to working
with the data. Therefore, different types of gridded data sets will be used
in different situations. Dedicated articles are available highlighting 
specific characteristics and explicit examples for the different types of data.
Namely:

* [Gridded analysis data](gridded_analysis.Rmd)
* [Gridded forecast data](gridded_forecasts.Rmd)
* [Gridded hindcast data](gridded_hindcast.Rmd) (reforecasts)

Note that these articles will often refer back to this 'getting started' article
as most functions/procedures work the very same independent of the type of gridded
data.



## Underlying concept {#gridded-concept}

The data set has been designed and prepared by colleagues at the
[RMI](https://climdyn.meteo.be/) in Brussles (part of part of the R&D Department
of the Royal Meteorological Institute of Belgium).  The gridded data set
consists of different [ECMWF](https://www.ecmwf.int) products (see
[LICENSE](https://github.com/retostauffer/eupp/blob/main/DATA_LICENSE)) with
access granted via the `europeanweather.cloud` S3 bucket.

All gridded data sets are stored as GRIB version 1 files, alongside with
a GRIB index file. These files can technically be accessed directly, however,
this may be inconvenient for most/some. Thus, the _eupp_ package provides
an interface to download the data.


![Rough scheme on the download/processing process.](images/download_grib.svg)

Independent of the product or subset, the procedure for all products is the same:

1. Define what data should be downloaded (`eupp_config()`).
2. Download/retrieve the data (GRIB version 1, NetCDF, [`stars`][stars].

This article contains a series of links to the article
"[_Gridded data: Advanced_](gridded_advanced.html)" not required to follow as
casual users but might be helpful to show some insights to more advanced users,
programmers, and supporters.

<div style="color: gray;">
Under the hood, the _eupp_ package performs a series of intermediate steps
for (2) to achive the goal. 

a.  Defining the GRIB index files required to identify the necessary GRIB messages
b.  Downloading and parsing the GRIB index files to identify files and byte ranges
c.  Partially downloading the GRIB files (required messages via `curl`) and stores
    the requested messages in a new GRIB version 1 file.
d.  If a NetCDF file has been requested: making required manipulations on the GRIB
    file and converting it to NetCDF, wherefore [ecCodes][ecCodes] needs to be installed.
e.  If a [`stars`][stars] object has been requested:
    read the NetCDF file. This goes trough the intermediate step of creating a NetCDF
    file; thus [ecCodes][ecCodes] is necessary.
</div>


## Define dataset to be downloaded {#gridded-config}

Step one
Before starting downloading data, a configuration object must be created using
`eupp_config()` which contains the specification of the data to be retrieved.


```{r, include = FALSE}
dir.create("_cache", showWarnings = FALSE) # Not mandatory
```

```{r}
# Loading the package
library("eupp")

# Create custom configuration
conf <- eupp_config(product   = "forecast",
                    level     = "surf",
                    type      = "ens",
                    date      = "2017-07-01",
                    parameter = c("cp", "2t"),
                    steps     = c(24L, 240L), # +1 and +10 days ahead
                    cache     = "_cache")     # optional; caching grib index
```

## Get full file URL

If you are interested where the data is stored, you can make use of the
function `eupp_get_source_urls()`. Typically not required to be called by an end-user.

```{r}
urls <- eupp_get_source_urls(conf)                           # GRIB file
urls <- eupp_get_source_urls(conf, fileext = "index")        # GRIB index/inventory
```

## Getting GRIB inventory

Given the configuration object `conf` from above, we can now retrieve the GRIB
inventory which matches our requirements.

```{r}
inv <- eupp_get_inventory(conf)
dim(inv)
head(inv, n = 3)
```

As we have set `cache` when calling `eupp_config()` the GRIB index file is
stored locally. If the same index file is required once again the loading times
should be much faster as the cached file is reused. Not required but may save
some time in certain situations.


## Getting data: GRIB format {#gridded-download-grib}

From `eupp_get_inventory()` we know that there are `r nrow(inv)` fields matching
our configuration. `eupp_download_gridded()` allows us to retrieve the data in
the original GRIB version 1 file format by specifying `output_format = "grib"`.

The function will first download/parse the GRIB index file (uses `cache` if specified)
to know which GRIB messages are required given the configuration (`conf`) before starting
to download the requires messages. All messages matching the configuration will be stored
in one single file specified by `output_file` (GRIB version 1 file format).

```{r}
eupp_download_gridded(conf, output_file = "_test.grb", output_format = "grib", overwrite = TRUE)
```

## Getting data: NetCDF format {#gridded-download-netcdf}

Alternatively, the function allows to specify `output_format = "nc"` to store
the data in the NetCDF file format. The procedure is, in large parts, similar
to retrieving the data in GRIB format (see above). The function first downloads
and stores the data in a temporary GRIB file before calling
[`grib_to_netcdf`](https://confluence.ecmwf.int/display/ECC/grib_to_netcdf); a console
tool provided by ECMWFs [ecCodes](https://confluence.ecmwf.int/display/ECC/ecCodes+Home).

There seem to be ways to use `ecCodes` under Windows, see
[here](https://github.com/nawendt/gribr#windows-install-options) or
[here](https://www.ecmwf.int/en/newsletter/159/news/eccodes-and-magics-available-under-windows).

`grib_to_netcdf` is called with option `-k 3` resulting in a file with the
'netCDF-4 file format'.  Can be changed by adjusting the argument `netcdf_kind`
(default `3`, see `grib_to_netcdf` documentation).
Note that the conversion from GRIB to NetCDF adjusts the
variable names if needed (e.g., `2t` gets `t2m`).

```{r}
eupp_download_gridded(conf, output_file = "_test.nc", output_format = "nc", overwrite = TRUE)
```

These files can later be processed with the packages/software of your choice
(e.g., via [`ncdf4`][netcdf4],
[`stars`][stars], CDS, ...).
Some examples how to proceed from here ...

##### Reading data using `ncdf4`

```{r}
library("ncdf4")
nc <- nc_open("_test.nc")
nc
```

##### Reading data using `stars`

```{r demo_read_stars, eval = FALSE}
library("stars")
x <- read_stars("_test.nc")
```

```{r demo_read_stars_hidden, include = FALSE}
library("stars")
x <- read_stars("_test.nc")
```

```{r gridded_demoplot_stars, fig = TRUE, fig.width = 10, fig.height = 5, out.width = "100%"}
print(x)
dim(x)
names(x)
st_get_dimension_values(x, "time") # date/time when valid

# Plotting 2m dry air temperature
plot(x["t2m"],
     main   = "t2m",
     col    = hcl.colors(21, "Blue-Red 2", rev = TRUE),
     breaks = seq(min(x$t2m, na.rm = TRUE), max(x$t2m, na.rm = TRUE), length = 22))

# Plotting convective precipitation (mm)
bk <- unique(quantile(x[["cp"]], p = seq(0, 1, by = 0.05)))
plot(x["cp"] * 1e3,
     main   = "cp",
     col    = hcl.colors(length(bk) - 1, "Purple-Yellow", rev = TRUE),
     breaks = bk * 1e3)
```

An alternative way to visualize the data using [`ggplot2`](https://cran.r-project.org/package=ggplot2),
[`colorspace`](https://cran.r-project.org/package=colorspace) and 
[`sf`](https://cran.r-project.org/package=sf) as well as 
[`rnaturalearth`](https://cran.r-project.org/package=rnaturalearth) for outlines:
```


```{r gridded_demoplot_ggplot, fig = TRUE, fig.width = 10, fig.height = 7, out.width = "60%", fig.align = "center"}
library("sf")
library("ggplot2")
library("colorspace")
library("rnaturalearth")

ne <- ne_countries(continent = "europe", returnclass = "sf")
st_crs(x) <- st_crs(ne)

# Plotting convective precipitation; member number 10.
# x["cp",,,number_idx,] is subsetting the stars object.
number_idx <- which(st_get_dimension_values(x, "number") == 10)
ggplot() + geom_stars(data = x["cp",,,number_idx,] * 1e3) +
           facet_wrap("time") +
           scale_fill_continuous_sequential("Purple-Yellow") +
           geom_sf(data = ne, fill = "transparent") +
           coord_sf(xlim = c(-6, 17), ylim = c(36, 67), expand = FALSE)
```

```{r demoplot_ggplot_lambert, fig = TRUE, fig.width = 10, fig.height = 7, out.width = "80%", fig.align = "center"}
# CRS ESRI:102014: Europe_Lambert_Conformal_Conic projection
# Hardcoded x/y-limits added; limit to southern Europe.
tmp <- st_transform(x, crs = st_crs("ESRI:102014"))
ggplot() + geom_stars(data = tmp["t2m",,,1,2]) +
           scale_fill_continuous_sequential("Red-Yellow") +
           geom_sf(data = ne, fill = "transparent") +
           coord_sf(xlim = c(-1.2e6, 6e5), ylim = c(7e5, 2e6), expand = TRUE)
```

## Getting data: `stars` {#gridded-get-stars}

As an alternative the package allows to directly retrieve the data as a [`stars`][stars]
object. Under the hood _eupp_ will download the gridded data set, converts it into 
a NetCDF file before calling `read_stars()`. Thus, [ecCodes][eccodes] will be required
as well and the variable names may differ from the original GRIB short name.

An example using the existing configuration `conf`:

```{r, results = "hidden"}
xst <- eupp_get_gridded(conf)
```

```{r gridded_get_stars, fig = TRUE, fig.width = 10, fig.height = 5, out.width = "100%", results = "hidden"}
class(xst)
names(xst)
print(xst)

plot(xst["t2m"], col = hcl.colors(11, "Green-Orange"))
```

To be precise, the object returned is of class ``r deparse(class(xst))`` which is
a pure `stars` object; the `eupp_stars` extension adds some additional functionality
for data handling (see `methods(class = "eupp_stars")`).



```{r gridded_cleaning_up, include = FALSE}
if (dir.exists("_cache")) unlink("_cache")
if (file.exists("_test.nc")) unlink("_test.nc")
if (file.exists("_test.grb")) unlink("_test.grb")
```




[ecCodes]: https://confluence.ecmwf.int/display/ECC/ecCodes+Home
[stars]: https://cran.r-project.org/package=stars
[netcdf4]: https://cran.r-project.org/package=ncdf4
