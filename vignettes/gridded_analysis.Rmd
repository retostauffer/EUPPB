---
title: "Gridded Analysis"
---

```{r, include = FALSE}
suppressPackageStartupMessages(library("eupp"))
suppressPackageStartupMessages(library("sf"))
suppressPackageStartupMessages(library("stars"))
suppressPackageStartupMessages(library("rjson"))
dir.create("_cache", showWarnings = FALSE)
library("rjson")
```

This example shows how to download gridded analysis data. The data set
is based on ECMWFs latest ERA5 reanalysis. For details on the basic use
of _eupp_ gridded functionality please have a look at the
[Getting started](gridded.html) article.

Gridded analysis data (based on ECMWFs ERA5 reanalysis) is available
for a series of surface and pressure level fields introcuded below.


## Surface data


#### Parameters

```{r gridded_analysis_surface_table, echo = FALSE}
conf <- eupp_config("analysis", "surface", date = "2017-01-01", step = 5, cache = "_cache")
eupp_download_gridded(conf, "_test.grb", "grib", overwrite = TRUE)
tmp <- system("grib_ls -j -p shortName,name _test.grb", intern = TRUE)
tmp <- fromJSON(paste(tmp, collapse = ""))
tmp <- do.call(rbind, lapply(tmp[[1]], as.data.frame))
tmp <- data.frame(product = conf$product, level = conf$level,
                  param = tmp$shortName, description = tmp$name)
knitr::kable(tmp)
```

#### Available steps

When downloading analysis date, the argument `steps` (`eupp_config()`)
defines the time of the day of the data to be processed.

```{r gridded_analysis_surface_request}
conf <- eupp_config("analysis", "surface",
                    param = c("2t", "cp"),
                    date  = "2018-07-01",
                    steps = 0:23,
                    cache = "_cache")
ana  <- eupp_get_gridded(conf)

# Location to be interpolated
library("sf")
ibk <- data.frame(name = "Innsbruck", lon  = 11.39, lat = 47.27)
res <- st_extract(ana, at = st_as_sf(ibk, coords = c("lon", "lat")), bilinear = TRUE)
as.data.frame(res)
```

#### Downloading and processing

For details how to download the data defined by the configuration above
please visit the [Getting started](gridded.html) article.




## Pressure level data

#### Parameters

```{r gridded_analysis_pressure_table, echo = FALSE}
conf <- eupp_config("analysis", "pressure", date = "2017-01-01", step = 5, cache = "_cache")
eupp_download_gridded(conf, "_test.grb", "grib", overwrite = TRUE)
tmp <- system("grib_ls -j -p level,shortName,name _test.grb", intern = TRUE)
tmp <- fromJSON(paste(tmp, collapse = ""))
tmp <- do.call(rbind, lapply(tmp[[1]], as.data.frame))
tmp <- data.frame(product = conf$product, level = conf$level,
                  param = sprintf("%s (%d)", tmp$shortName, tmp$level),
                  description = tmp$name)
knitr::kable(tmp)
```

#### Available steps

When downloading analysis date, the argument `steps` (`eupp_config()`)
defines the time of the day of the data to be processed.

```{r gridded_analysis_pressure_request}
conf <- eupp_config("analysis", "pressure",
                    param = c("t", "r"),
                    date  = "2018-07-01",
                    steps = 0:23,
                    cache = "_cache")
ana  <- eupp_get_gridded(conf)

dim(inv <- eupp_get_inventory(conf))
head(inv)
tail(inv)
table(inv$step, inv$param)

eupp_download_gridded(conf, "_test.grb", "grib", overwrite = TRUE)
system("grib_ls _test.grb")

k <- eupp_get_gridded(conf)
k

# Location to be interpolated
ibk <- data.frame(name = "Innsbruck", lon  = 11.39, lat = 47.27)
res <- st_extract(ana, at = st_as_sf(ibk, coords = c("lon", "lat")), bilinear = TRUE)
as.data.frame(res)
```

#### Downloading and processing

For details how to download the data defined by the configuration above
please visit the [Getting started](gridded.html) article.





